<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <title>PPO - Inventario</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    button {
      touch-action: manipulation;
      transform: none !important;
      will-change: auto;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      outline: none;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: transparent;
      color: #1C1C1C;
      min-height: 100vh;
      overflow-y: auto;
    }
    .app-header {
      position: sticky;
      top: 0;
      z-index: 20;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .75rem 1rem;
      background: #f5f5f5;
      border-bottom: 1px solid #ccc;
    }
    .brand .toyota { color: #EB0A1E; font-weight: 700; }
    .brand small { color: #4383EA; font-weight: 500; }
    #app { text-align: center; padding: 10px; }
    h2 { margin: 10px 0 5px; font-size: 1.4rem; font-weight: lighter; text-align: center; }
    p { font-size: 1rem; text-align: center; }
    #total { font-weight: bold; }
    .contenedor {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 10px;
    }
    .tarjeta {
      background: #f5f5f5;
      border-radius: 12px;
      padding: .8rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      text-align: center;
      position: relative;
      height: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 15px;
    }
    .tarjeta h3 {
      margin-bottom: 5px;
      font-size: 1.2rem;
      z-index: 3;
      position: relative;
    }
    .tarjeta button {
      position: absolute;
      top: 40%;
      left: 15%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 90px;
      font-size: 2rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: #4caf50;
      color: white;
      z-index: 2;
    }
    .tarjeta button:active {
      background: #3d8b40;
      transform: translate(-50%, -48%);
    }
    .tarjeta p {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1;
    }
    .acciones {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .acciones button {
      padding: .9rem;
      font-size: 1rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    .whatsapp { background: #25d366; color: white; }
    #previewModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    #previewContent {
      background: white;
      padding: 10px;
      border-radius: 10px;
      max-width: 90%;
      max-height: 90%;
      text-align: center;
    }
    #previewContent img { max-width: 100%; border-radius: 10px; }
    #closePreview {
      margin-top: 10px;
      padding: 8px 16px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="capturaZona">
    <header class="app-header">
      <div class="brand">
        <span class="toyota">PPO</span> <small>Baja California</small>
      </div>
      <div>| Post Production Option</div>
    </header>
    <div id="reporte">
      <h2>📊 Inventario Pre-Stage</h2>
      <p>Total: <span id="total">0</span> Unidades</p>
      <div class="contenedor">
        <div class="tarjeta">
          <h3>Línea B: <span id="countB">0</span></h3>
          <button onclick="sumar('B')">+1</button>
          <p><span id="porcB">0%</span></p>
        </div>
        <div class="tarjeta">
          <h3>Línea B1: <span id="countB1">0</span></h3>
          <button onclick="sumar('B1')">+1</button>
          <p><span id="porcB1">0%</span></p>
        </div>
        <div class="tarjeta">
          <h3>Línea C: <span id="countC">0</span></h3>
          <button onclick="sumar('C')">+1</button>
          <p><span id="porcC">0%</span></p>
        </div>
        <div class="tarjeta">
          <h3>Pendientes: <span id="countPendientes">0</span></h3>
          <button onclick="sumar('Pendientes')">+1</button>
          <p><span id="porcPendientes">0%</span></p>
        </div>
      </div>
    </div>
  </div>

  <div class="acciones">
    <button onclick="capturar()" class="whatsapp">📸 Capturar y Compartir</button>
  </div>

  <div id="previewModal">
    <div id="previewContent">
      <img id="previewImage" src="" alt="Reporte">
      <br>
      <button id="closePreview">Cerrar</button>
    </div>
  </div>

  <script>
    let contadores = { B: 0, B1: 0, C: 0, Pendientes: 0 };

    function sumar(cat) {
      contadores[cat]++;
      actualizar();
    }

    function actualizar() {
      let total = Object.values(contadores).reduce((a, b) => a + b, 0);
      document.getElementById("total").innerText = total;
      for (let cat in contadores) {
        document.getElementById("count" + cat).innerText = contadores[cat];
        let porc = total > 0 ? Math.round((contadores[cat] / total) * 100) : 0;
        document.getElementById("porc" + cat).innerText = porc + "%";
      }
    }

    function resetearContadores() {
      contadores = { B: 0, B1: 0, C: 0, Pendientes: 0 };
      actualizar();
    }

    function capturar() {
      // Obtener fecha y hora actual en Tijuana
      const fecha = new Date().toLocaleString("es-MX", {
        timeZone: "America/Tijuana",
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
      });

      // Formatear texto (mayúscula inicial y p.m./a.m. estilizado)
      const textoFecha = fecha
        .replace(/^\w/, c => c.toUpperCase())
        .replace("a. m.", "a.m.")
        .replace("p. m.", "p.m.");

      // Calcular total actual
      const total = Object.values(contadores).reduce((a, b) => a + b, 0);

      // Texto para compartir
      const leyendaTexto = `Reporte de inventario PPO ${textoFecha} — Total: ${total} unidades`;

      // Capturar la zona sin los botones
      html2canvas(document.querySelector("#capturaZona"), {
        ignoreElements: (element) => {
          if (element.closest(".tarjeta") && element.tagName === "BUTTON") return true;
          return false;
        },
        scale: window.devicePixelRatio
      }).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        document.getElementById("previewImage").src = imgData;
        document.getElementById("previewModal").style.display = "flex";

        if (navigator.share) {
          canvas.toBlob(blob => {
            const file = new File([blob], "reporte.png", { type: "image/png" });
            navigator.share({
              files: [file],
              title: "Reporte PPO Inventario",
              text: leyendaTexto
            }).then(() => {
              resetearContadores();
              document.getElementById("previewModal").style.display = "none";
            }).catch(error => {
              console.log("Error al compartir:", error);
              // Copiar texto al portapapeles si no se muestra
              navigator.clipboard.writeText(leyendaTexto).then(() => {
                alert("⚠️ El mensaje fue copiado al portapapeles.\nPégalo manualmente al compartir la imagen.");
              });
              resetearContadores();
              document.getElementById("previewModal").style.display = "none";
            });
          }, "image/png");
        } else {
          // Si no hay API de compartir, copiar el texto
          navigator.clipboard.writeText(leyendaTexto).then(() => {
            alert("Compartir no soportado. El texto del reporte fue copiado al portapapeles.");
          });
        }
      }).catch(error => {
        console.log("Error en html2canvas:", error);
      });
    }

    document.getElementById("closePreview").onclick = () => {
      document.getElementById("previewModal").style.display = "none";
    };

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('Service Worker registrado con éxito:', registration);
          })
          .catch(error => {
            console.log('Error al registrar el Service Worker:', error);
          });
      });
    }
  </script>
</body>
</html>
